# 从浏览器多进程到 JS 单线程

- 进程与线程
  - 进程是 cpu 资源分配最小的单位（系统为给他分配内存）
  - 线程是 cpu 调度的最小单位（线程是建立在进程的基础上的一次程序运行单位，一个进程中可以有多个线程）

**不同进程之间也可以通信，不过代价比较大。**
**现在，一般通用的叫法：单线程与多线程，都是指在一个进程内的单和多（所以核心还是得属于一个进程才行）**

## 浏览器是多进程的

- 浏览器是多进程的

- 浏览器之所以能够运行，是因为系统给它的进程分配了资源（cpu,内存）

- 简单点理解，每打开一个 Tab 页，就相当于创建了一个独立的浏览器进程。
  - **在这里浏览器应该也有自己的优化机制，有时候打开多个 Tab 页后，可以在 Chrome 任务管理器中看到，有些进程被合并了**

## 浏览器有那些进程

- Browser 进程：浏览器的主要进程（负责协调，主控），只有一个。作用有

  - 负责浏览器界面显示，与用户交互。如前进，后退等
  - 负责各个页面的管理，创建和销毁其他进程
  - 将 Render 进程得到的内存中的 Bitmap，绘制到用户界面上
  - 网络资源的管理，下载等

- 第三方插件进程：每种类型的插件对应一个进程，仅当使用该插件的时候才创建

- GPU 进程: 最多一个，用于 3D 绘制等

- 浏览器渲染进程（浏览器内核）（Renderer 进程，内部是多线程的）：默认每个 Tab 页面一个进程，互不影响。主要作用为
  - 页面渲染，脚本执行，事件处理等

## 浏览器多进程的优势

- 避免单个 page crash（崩溃）影响整个浏览器

- 避免第三方插件 crash 影响整个浏览器

- 多进程充分利用多核优势

- 方便使用沙盒模型隔离插件等进程，提高浏览器稳定性

### 浏览器沙盒模型（沙箱模型）（SandBox）

- 背景：对于网络上的网页，浏览器认为他们是不安全的，因为网页总是存在各种可能性，也许是无意的或有意的攻击。如果他有一种机制，将网页的运行限制在一个特定的环境种，也就是一个沙箱种，使他只能访问有限的功能。那么，即使网页工作的渲染引擎被攻击，它也不能够渲染引擎工作的主机系统中的任务权限，这一思想就是沙箱模型

- 原理：沙盒技术与主动防御技术原理截然不同。

  - 主动防御技术是发现有程序有可疑行为时立即拦截并终止运行。
  - 沙盒技术则是发现可以行为后让程序继续运行，当发现的确是病毒是才会停止。
  - 沙盒技术的实践运用流程是：让疑似病毒文件的可疑行为在虚拟的沙盒里充分表演，沙盒会去记下他的每一个动作；当疑似病毒充分暴露了其病毒属性后，沙盒就会执行回滚机制：将病毒的痕迹和动作抹去，恢复系统到正常状态
  - 沙盒的魅力就在于他允许你出错，还可以给你改正的机会。

- 沙箱模型工作的基本单位就是进程。每一个进程对应一个沙箱。

### 浏览器内核（渲染进程）

* 渲染进程是多线程的

* GUI 渲染线程
  - 负责渲染浏览器界面，解析 HTML，CSS，构建 DOM 树和 RenderObject 树，布局和绘制等。
  - 当界面需要重绘或由于某种操作引发回流时，该线程就会执行
  - **GUI 渲染线程与 JS 引擎线程是互斥的，当 JS 引擎执行时 GUI 线程会被挂起（相当于被冻结了），GUI 更新会被保存在一个队列中等到 JS 引擎空闲时立即被执行**

* JS引擎线程
    - 也称为JS内核负责处理Js脚本程序
    - JS引擎线程负责解析js脚本，运行代码
    - 