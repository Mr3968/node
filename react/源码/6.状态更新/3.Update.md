# Update

- 触发更新的方法所属组件分类

- HostRoot

  - ReactDOM.render

- ClassComponent

  - this.setState
  - this.forceUpdate

- FunctionComponent

  - useState
  - useReducer

- 不同类型的组件工作方式不同，所以存在两种不同结构的 Update 其中 ClassComponent 与 HostRoot 共用一套 Update 结构，FunctionComponent 单独使用一种 Update 结构

## ClassComponent 与 HostRoot 的 Update

### 结构

- ClassComponent 与 HostRoot（即 rootfiber.tag 对应类型）共用同一种 Update 结构

```
const update: Update<*> = {
  eventTime,
  lane,
  suspenseConfig,
  tag: UpdateState,
  payload: null,
  callback: null,

  next: null,
};
```

- eventTime：任务时间，通过 performance.now()获取的毫秒数，由于该字段在未来会重构
- lane：优先级相关字段
- suspenseConfig:Suspense 相关
- tag:更新的类型，包括 UpdateState | RelpaceState | ForceUpdate | CaptureUpdate
- payload:更新挂载的数据，不同类型组件挂载的数据不同，对于 ClassComponent,payload 为 this.setState 的第一个传参，对于 HostRoot，payload 为 ReactDOM.render 的第一个传参
- callback: 更新的回调函数，即在中提到的回调函数
- next: 与其他 Update 连接形成链表

### Update 与 Fiber 的联系

- Update 存在一个连接其他 Update 形成链表的字段--next。联系 React 中另一种以链表形式组成的结构--Fiber

- Fiber 节点组成 Fiber 树，页面中最多同时存在两棵 Fiber 树：

  - 代表当前页面状态的 current Fiber 树
  - 代表正在 render 阶段的 workInProgress Fiber 树

- 类似 Fiber 节点组成 Fiber 树，Fiber 节点上的多个 Update 会组成链表并被包含在 fiber.updateQueue 中
  - 为什么一个 Fiber 节点会存在多个 Update？

```
onClick() {
  this.setState({
    a: 1
  })

  this.setState({
    b: 2
  })
}
```

* 在一个ClassComponent中触发this.onClick方法，方法内部调用了两次this.setState 这会在该fiber中产生两个Update

* Fiber节点最多同时存在两个updateQueue:
    - current fiber保存的updateQueue即current updateQueue
    - workInProgress fiber保存的updateQueue即workInProgress updateQueue

* 在commit阶段完成页面渲染后，workInProgress Fiber树变为current Fiber树， workInProgress Fiber树内Fiber节点的updateQueue就变成 current updateQueue 


### updateQueue 

* updateQueue有三种类型
